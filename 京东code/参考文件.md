## 高超师傅
### 1. 白条报表
#### 1.1收单侧分场景基础报表

```python

# !/usr/bin/env python
# -*- coding: utf-8 -*-

from template.base_sql_task import *


#
# 目前支持：RUNNER_SPARK_SQL和RUNNER_HIVE
#
sql_runner=RUNNER_HIVE


def get_customized_items():
    """
     if you need some special values in your sql, please define and calculate then here
     to refer it as {YOUR_VAR} in your sql
    """
    today = Time.today()
    TX_PRE_60_DATE = Time.date_sub(date=today, itv=60)
    TX_PRE_365_DATE = Time.date_sub(date=today, itv=365)
    return locals()


sql_map={

     # ATTENTION:   ！！！！ sql_01  因为系统按字典顺序进行排序，小于10 的一定要写成0加编号，否则会顺序混乱，数据出问题，切记，切记！！！！
    "sql_01": """
    use dmc_tmp;
--获取收单侧指标数据

  
DROP TABLE  if exists dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_00;
CREATE TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_00 AS
select substr(loan_time,1,10) as dim_day_id
       ,count(distinct user_pin) as daily_activity   --日活用户量
       ,count(distinct case when is_first_pai = 1 then user_pin end) as daily_new_activity  --新增活跃量
       ,count(distinct loan_id) as daily_order_num  --订单量
       ,sum(loan_prin-refund_prin) as daily_turnover   --总GMV
       ,sum(case when cnv_time is not null then 0
                 when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then (loan_prin-refund_prin)*0.008+recvbl_stag_fee
                 when jd_jr_out in ('商城') then (loan_prin-refund_prin)*0.008+recvbl_stag_fee else recvbl_stag_fee end) as recvbl_stag_fee  --收入，用来算变现率
       ,count(distinct case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then user_pin
                 when jd_jr_out in ('商城') then user_pin end) as nei_daily_activity  --内单日活量
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then loan_prin-refund_prin
                 when jd_jr_out in ('商城') then loan_prin-refund_prin else 0 end) as nei_daily_turnover  --内单GMV
       ,sum(case when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then (loan_prin-refund_prin) 
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('商城') then (loan_prin-refund_prin)  else 0 end) as nei_ins_trans_Amount --内单付费交易额
       ,sum(case when recvbl_stag_fee <= 0 and cnv_time is null and loan_term>1 and sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then (loan_prin-refund_prin) 
                 when recvbl_stag_fee <= 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('商城') then (loan_prin-refund_prin)  else 0 end) as nei_int_free_trading_amount  --内单分期免息交易额
       ,sum(case when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then (loan_prin-refund_prin)*loan_term*actl_fee_rate
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('商城') then (loan_prin-refund_prin)*loan_term*actl_fee_rate  else 0 end) as nei_ins_trans_Amount_lilv  --内单付费交易额利率加权
       ,sum(case when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then (loan_prin-refund_prin)*loan_term
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('商城') then (loan_prin-refund_prin)*loan_term  else 0 end) as nei_ins_trans_period   --内单付费期数加权
       ,sum(case when recvbl_stag_fee <= 0 and cnv_time is null and loan_term>1 and sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then (loan_prin-refund_prin)*loan_term
                 when recvbl_stag_fee <= 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('商城') then (loan_prin-refund_prin)*loan_term  else 0 end) as nei_int_free_period   --内单分期免息期数加权
       ,count(distinct case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then loan_id
                 when jd_jr_out in ('商城') then loan_id end) as nei_daily_order_num --内单订单量
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then nvl(discountamount,0)
                 when jd_jr_out in ('商城') then nvl(discountamount,0)  else 0 end) as nei_discountamount  --内单本金补贴
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when jd_jr_out in ('外部') then loan_prin-refund_prin else 0 end) as wai_daily_turnover  --外单GMV
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('外部') then (loan_prin-refund_prin)  else 0 end) as wai_ins_trans_Amount --外单付费交易额
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee <= 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('外部') then (loan_prin-refund_prin)  else 0 end) as wai_int_free_trading_amount  --外单分期免息交易额
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('外部') then (loan_prin-refund_prin)*loan_term*actl_fee_rate  else 0 end) as wai_ins_trans_Amount_lilv  --外单付费交易额利率加权
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('外部') then (loan_prin-refund_prin)*loan_term  else 0 end) as wai_ins_trans_period   --外单付费期数加权
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee <= 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('外部') then (loan_prin-refund_prin)*loan_term  else 0 end) as wai_int_free_period   --外单分期免息期数加权
       ,count(distinct case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then null
                 when jd_jr_out in ('外部') then loan_id end) as wai_daily_order_num --外单订单量
       ,count(distinct case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then null
                 when jd_jr_out in ('外部') then user_pin end) as wai_daily_activity --外单活跃量
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when jd_jr_out in ('金融') then loan_prin-refund_prin else 0 end) as jr_daily_turnover  --金融GMV
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('金融') then (loan_prin-refund_prin)  else 0 end) as jr_ins_trans_Amount --金融付费交易额
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee <= 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('金融') then (loan_prin-refund_prin)  else 0 end) as jr_int_free_trading_amount  --金融分期免息交易额
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('金融') then (loan_prin-refund_prin)*loan_term*actl_fee_rate  else 0 end) as jr_ins_trans_Amount_lilv  --金融付费交易额利率加权
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee > 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('金融') then (loan_prin-refund_prin)*loan_term  else 0 end) as jr_ins_trans_period   --金融付费期数加权
       ,sum(case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then 0
                 when recvbl_stag_fee <= 0 and cnv_time is null and loan_term>1 and jd_jr_out in ('金融') then (loan_prin-refund_prin)*loan_term  else 0 end) as jr_int_free_period   --金融分期免息期数加权
       ,count(distinct case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then null
                 when jd_jr_out in ('金融') then loan_id end) as jr_daily_order_num --金融订单量
       ,count(distinct case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then null
                 when jd_jr_out in ('金融') then user_pin end) as jr_daily_activity --金融活跃量
from 
(select t.*
        ,row_number() over(PARTITION by user_pin order by loan_time asc) as is_first_pai
 from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d t
 where dt = '{TX_DATE}'
 and (biz_id not in ('8','9','10','11','12','13','16','23','25','26','32','64','65') or biz_id is null)) t1
 left join (select user_pin as pin
                  ,ordr_id as orderid
                  ,prin_camp_amt as discountamount
                  ,prefr_type as type
           from (select *
                       ,row_number() over (partition by ordr_id,coupon_code order by dt desc) as rn
                 from idm.idm_f05_bt_coupon_ordr_i_d) t
                 where rn=1
                 and prefr_type in ('csf_zj','csf_mj','csf_sjlj')) t2
on t1.ordr_id=t2.orderid
left join dmc_add.dmcadd_add_cf_xbt_sourcetype_bizcode_i_d t3
on t1.src_type=t3.sourcetype and t1.biz_id=t3.bizcode
where substr(loan_time,1,10) = '{TX_DATE}'
group by substr(loan_time,1,10);
    """,

    "sql_02": """
    use dmc_tmp;
--白条用户商城交易情况



DROP TABLE  if exists dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_01;
CREATE TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_01 AS
select
  '{TX_DATE}'  as sale_ord_dt
  ,count(distinct user_log_acct) as sc_user_num  --白条用户当天商城活跃情况
  ,count(distinct case when t2.ordr_id is not null then user_log_acct end) as bt_user_num --白条用户当天商城使用白条活跃情况
  ,count(distinct parent_sale_ord_id) as sc_order_num  --白条用户当天商城订单情况
  ,count(distinct case when t2.ordr_id is not null then parent_sale_ord_id end) as bt_order_num  --白条用户当天商城使用白条订单情况
 ,sum(user_actual_pay_amount)                                                                 as amount_sc       --白条用户当天商城交易额                                                                         
 ,sum(case when t2.ordr_id is not null then user_actual_pay_amount else 0 end)                as bt_net_amount --白条用户当天在商城交易额使用白条支付的
from (select substr(sale_ord_dt,1,10) as sale_ord_dt
             ,user_log_acct
             ,parent_sale_ord_id
             ,user_actual_pay_amount
      from odm.odm_jdmall_sale_ordr_m04_sum_dtl_i_d 
      where dt>= '{TX_DATE}' 
      and sale_ord_dt ='{TX_DATE}' 
      and sale_ord_valid_flag=1) t1
left join (select ordr_id
            from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d
            where dt = '{TX_DATE}' 
            and substr(loan_time,1,10) = '{TX_DATE}') t2
on t1.parent_sale_ord_id =t2.ordr_id
inner join (select dt
                   ,pin as user_pin
                   ,planrate
                   ,createtime
            from odm.ODM_CF_ACCOUNT_S_D
            where dt in ('{TX_DATE}' )
            and accounttype in ('0','1','5','6') )t3 
on t1.user_log_acct =t3.user_pin;
    """,

    "sql_03": """
use dmc_tmp;
--商城交易中，白条交易占比



DROP TABLE  if exists dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_02;
CREATE TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_02 AS
select
  '{TX_DATE}'  as sale_ord_dt
  ,count(distinct user_log_acct) as sc_user_num_all  --当天商城活跃情况
  ,count(distinct case when t2.ordr_id is not null then user_log_acct end) as bt_user_num_all --当天商城使用白条活跃情况
  ,count(distinct parent_sale_ord_id) as sc_order_num_all  --当天商城订单情况
  ,count(distinct case when t2.ordr_id is not null then parent_sale_ord_id end) as bt_order_num_all  --当天商城使用白条订单情况
 ,sum(user_actual_pay_amount)                                                                 as amount_sc_all       --当天商城交易额                                                                         
 ,sum(case when t2.ordr_id is not null then user_actual_pay_amount else 0 end)                as bt_net_amount_all --当天在商城交易额使用白条支付的
from (select substr(sale_ord_dt,1,10) as sale_ord_dt
             ,user_log_acct
             ,parent_sale_ord_id
             ,user_actual_pay_amount
      from odm.odm_jdmall_sale_ordr_m04_sum_dtl_i_d 
      where dt>= '{TX_DATE}' 
      and sale_ord_dt ='{TX_DATE}' 
      and sale_ord_valid_flag=1) t1
left join (select ordr_id
            from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d
            where dt = '{TX_DATE}' 
            and substr(loan_time,1,10) = '{TX_DATE}') t2
on t1.parent_sale_ord_id =t2.ordr_id;
    """,
    
        "sql_04": """
use dmc_tmp;


DROP TABLE  if exists dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_03;
CREATE TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_03 AS
select '{TX_DATE}'  as sale_ord_dt
       ,sum(amount-refundamt)  as loan_prin
       ,sum(planfee-planfeediscount-cxplanfeedst-cxplanfeeamt) as planfee  --应收账单分期手续费
from ODM.ODM_CF_BILL_DETAIL_0000_S_D
where dt= '{TX_DATE}'
and (bizcode  not in ('8','9','10','11','12','13','16','23','25','26','32','64','65')or bizcode is null)
and plantype in ('2','3','4')
and to_date(coalesce(billplandate,autoplandate)) = '{TX_DATE}';

    """,
    
        
        "sql_05": """
use dmc_tmp;


drop table  if exists dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d;
create table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d
as
select '{TX_DATE}' as dim_day--日期
       ,'-' as user_pin
       ,daily_activity   --日活用户量
       ,daily_new_activity  --新增活跃量
       ,daily_order_num  --订单量
       ,daily_turnover   --总GMV
       ,recvbl_stag_fee  --收入，用来算变现率
       ,nei_daily_activity  --内单日活量
       ,nei_daily_turnover  --内单GMV
       ,nei_ins_trans_Amount --内单付费交易额
       ,nei_int_free_trading_amount  --内单分期免息交易额
       ,nei_ins_trans_Amount_lilv  --内单付费交易额利率加权
       ,nei_ins_trans_period   --内单付费期数加权
       ,nei_int_free_period   --内单分期免息期数加权
       ,nei_daily_order_num --内单订单量
       ,nei_discountamount  --内单本金补贴
       ,wai_daily_turnover  --外单GMV
       ,wai_ins_trans_Amount --外单付费交易额
       ,wai_int_free_trading_amount  --外单分期免息交易额
       ,wai_ins_trans_Amount_lilv  --外单付费交易额利率加权
       ,wai_ins_trans_period   --外单付费期数加权
       ,wai_int_free_period   --外单分期免息期数加权
       ,wai_daily_order_num --外单订单量
       ,wai_daily_activity  --外单活跃量
       ,jr_daily_turnover  --金融GMV
       ,jr_ins_trans_Amount --金融付费交易额
       ,jr_int_free_trading_amount  --金融分期免息交易额
       ,jr_ins_trans_Amount_lilv  --金融付费交易额利率加权
       ,jr_ins_trans_period   --金融付费期数加权
       ,jr_int_free_period   --金融分期免息期数加权
       ,jr_daily_order_num --金融订单量
       ,jr_daily_activity --金融活跃量
       ,sc_user_num  --白条用户当天商城活跃情况
       ,bt_user_num --白条用户当天商城使用白条活跃情况
       ,sc_order_num  --白条用户当天商城订单情况
       ,bt_order_num  --白条用户当天商城使用白条订单情况
       ,amount_sc       --白条用户当天商城交易额        
       ,bt_net_amount --白条用户当天在商城交易额使用白条支付的
       ,sc_user_num_all  --当天商城活跃情况
       ,bt_user_num_all --当天商城使用白条活跃情况
       ,sc_order_num_all  --当天商城订单情况
       ,bt_order_num_all  --当天商城使用白条订单情况
       ,amount_sc_all       --当天商城交易额
       ,bt_net_amount_all --当天在商城交易额使用白条支付的
       ,loan_prin  --后分期交易额
       ,planfee  --后分期手续费
       ,(recvbl_stag_fee+planfee)/(daily_turnover+loan_prin) as bianxianlv --变现率
       ,bt_user_num/sc_user_num as bt_yh_sc_stl_yh --白条用户商城渗透率-用户
       ,bt_order_num/sc_order_num as bt_yh_sc_stl_dd --白条用户商城渗透率-订单
       ,bt_net_amount/amount_sc as bt_yh_sc_stl_jy --白条用户商城渗透率-交易
       ,bt_user_num_all/sc_user_num_all as bt_sc_stl_yh  --白条商城渗透率--用户
       ,bt_order_num_all/sc_order_num_all as bt_sc_stl_dd  --白条商城渗透率--订单
       ,bt_net_amount_all/amount_sc_all as bt_sc_stl_jy  --白条商城渗透率-交易
       ,(nei_ins_trans_Amount+nei_int_free_trading_amount)/nei_daily_turnover as nei_fenqi_jiaoyi_zhanbi  --内单分期占比
       ,nei_ins_trans_Amount_lilv/(nei_ins_trans_period+nei_int_free_period) as nei_fenqi_zhixing_feilv --内单分期执行费率
       ,(nei_ins_trans_period+nei_int_free_period)/(nei_ins_trans_Amount+nei_int_free_trading_amount) as nei_fenqi_qishu --内单分期平均期数
       ,nei_discountamount/nei_daily_order_num as nei_danjun_butie --内单单均补贴
       ,nei_daily_order_num/daily_order_num as nei_danliang_zhanbi  --内单单量占比
       ,wai_daily_order_num/daily_order_num as wai_danliang_zhanbi  --外单单量占比
       ,(wai_ins_trans_Amount+wai_int_free_trading_amount)/wai_daily_turnover as wai_fenqi_jiaoyi_zhanbi  --外单分期占比
       ,wai_ins_trans_Amount_lilv/(wai_ins_trans_period+wai_int_free_period) as wai_fenqi_zhixing_feilv --外单分期执行费率
       ,(wai_ins_trans_period+wai_int_free_period)/(wai_ins_trans_Amount+wai_int_free_trading_amount) as wai_fenqi_qishu --外单分期平均期数
       ,wai_daily_activity/daily_activity as wai_huoyuerenshu_zhanbi  --外单活跃人数占比
       ,jr_daily_order_num/daily_order_num as jr_danliang_zhanbi  --金融单量占比
       ,(jr_ins_trans_Amount+jr_int_free_trading_amount)/jr_daily_turnover as jr_fenqi_jiaoyi_zhanbi  --金融分期占比
       ,jr_ins_trans_Amount_lilv/(jr_ins_trans_period+jr_int_free_period) as jr_fenqi_zhixing_feilv --金融分期执行费率
       ,jr_daily_activity/daily_activity as jr_huoyuerenshu_zhanbi  --金融活跃人数占比
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_00 t1
join dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_01 t2 
on t1.dim_day_id=t2.sale_ord_dt
join dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_02 t3 
on t1.dim_day_id=t3.sale_ord_dt
join dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_03 t4
on t1.dim_day_id=t4.sale_ord_dt;

    """,
    
    "sql_06": """
    use dmc_bc;
    

insert overwrite table dmc_bc.dmcbc_xfjr_cf_xbt_divid_data_split_i_d partition (dt ='{TX_DATE}')
SELECT *
FROM dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d --明细
;
       
       """,
}


# 以下部分无需改动，除非作业有特殊要求
sql_task = SqlTask()
sql_task.set_sql_runner(sql_runner)
sql_task.set_customized_items(get_customized_items())
return_code = sql_task.execute_sqls(sql_map)
exit(return_code)
```


#### 1.2小白条人均出账数据-多进程

status!=2   没有全部退款完成
```sql
#######################################################################################################################
# Write SQL For Your APP
sub getsql
{
    my @SQL_BUFF=();
    #########################################################################################
    ####################################以下为SQL编辑区######################################
    #########################################################################################
    $SQL_BUFF[0]=qq(
    set mapred.job.name=dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_00;
use dmc_tmp;
--获取账单侧出账数据

DROP TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_00;
CREATE TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_00 AS
select billdate
       ,pin
       ,plantype
       ,sum(oriallowplanamt) as oriallowplanamt
       ,sum(planedamt) as planedamt
       ,sum(billamt) as billamt
from
(select substr(billdate,1,10) as billdate
       ,pin
       ,plantype
       ,0 as oriallowplanamt   --因为0状态的订单，原始可分期金额随时会变化，故从账单表里拿到用户出账时对应的出账时可分期金额来补充（此出账可分期金额仅指订单不分期对应的可分期金额，不包括二次分期的，未来有一个新的字段，来表明出账时二次分期可分期金额）。
       ,sum(planedamt) as planedamt
       ,sum(amount) as billamt
from ODM.ODM_CF_BILL_DETAIL_0000_S_D
where dt='$TX_DATE'
and (bizcode not in ('8','9','10','11','12','13','16','23','25','26') or bizcode is null)
and plantype in ('0','1','2','3','4')
and amount > 0
and status!=2  
and productid in ('0','1','5','6')
and substr(billdate,1,10) between date_add('$TX_DATE',-12) and '$TX_DATE'
group by substr(billdate,1,10)
       ,plantype
       ,pin
union all
select substr(billdate,1,10) as billdate
       ,pin
       ,0 as plantype
       ,sum(finaloriallowplanamt) as oriallowplanamt                      --因为0状态的订单，原始可分期金额随时会变化，故从账单表里拿到用户出账时对应的出账时可分期金额来补充（此出账可分期金额仅指订单不分期对应的可分期金额，不包括二次分期的，未来有一个新的字段，来表明出账时二次分期可分期金额）。
       ,0 as planedamt
       ,0 as billamt
from ODM.ODM_CF_BILL_0000_S_D
where dt='$TX_DATE'
and substr(billdate,1,10) between date_add('$TX_DATE',-12) and '$TX_DATE'
and billamt > 0
group by substr(billdate,1,10)
       ,pin
union all
select substr(billdate,1,10) as billdate
       ,pin
       ,1 as plantype
       ,sum(finalorisecondplanamt) as oriallowplanamt                      --因为1和2状态的订单，原始可分期金额随时会变化，故从账单表里拿到用户出账时对应的出账时可分期金额来补充，但是把1和2两种类型都归类到1上（此出账可分期金额仅指订单不分期对应的可分期金额，不包括二次分期的，未来有一个新的字段，来表明出账时二次分期可分期金额）。
       ,0 as planedamt
       ,0 as billamt
from ODM.ODM_CF_BILL_0000_S_D
where dt='$TX_DATE'
and substr(billdate,1,10) between date_add('$TX_DATE',-12) and '$TX_DATE'
and billamt > 0
group by substr(billdate,1,10)
       ,pin) tt
group by billdate
       ,pin
       ,plantype;
);

$SQL_BUFF[1]=qq(
set mapreduce.job.name=dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_01;
use dmc_tmp;
--获取每日账单分期数据

DROP TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_01;
CREATE TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_01 AS
select substr(coalesce(billplandate,autoplandate),1,10) as date1
        ,pin
        ,plannum
        ,sum(amount-refundamt) as amount
        ,sum(planfee-planfeediscount-cxplanfeedst-cxplanfeeamt) as zhekou_fee
        ,sum(planfee-cxplanfeedst-cxplanfeeamt) as fee
from ODM.ODM_CF_BILL_DETAIL_0000_S_D
where dt='$TX_DATE'
and (bizcode  not in('8','9','10','11','12','13','16','23','25','26','32')or bizcode is null)
and status!=2  
and plantype in ('3','4')
and substr(coalesce(billplandate,autoplandate),1,10) between date_add('$TX_DATE',-12) and '$TX_DATE'
and amount-refundamt>0
group by substr(coalesce(billplandate,autoplandate),1,10)
        ,pin
        ,plannum;
);

$SQL_BUFF[2]=qq(
set mapreduce.job.name=dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_02;
use dmc_tmp;

DROP TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d;
CREATE TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d AS
select dim_day_id     
       ,'-' as user_pin                             
       ,sum(Install_amount) as  Install_amount             
       ,sum(is_Install_amount)    as   is_Install_amount          
       ,sum(Payment_amount)      as     Payment_amount      
       ,sum(stage_conversion_rate)      as stage_conversion_rate          
       ,sum(installable_amount_rate)     as      installable_amount_rate      
       ,sum(sec_Install_amount)         as    sec_Install_amount    
       ,sum(sec_is_Install_amount)         as   sec_is_Install_amount     
       ,sum(sec_Payment_amount)           as   sec_Payment_amount   
       ,sum(sec_Stage_conversion_rate)      as   sec_Stage_conversion_rate        
       ,sum(sec_installable_amount_rate)    as    sec_installable_amount_rate         
       ,sum(avg_stage)   as avg_stage
       ,sum(Imp_rate)    as Imp_rate
       ,sum(avg_income)  as avg_income
       ,sum(fenqi_amount) as fenqi_amount
from 
(select billdate as dim_day_id
       ,planedamt/chuzhang_user_num as Install_amount
       ,oriallowplanamt/chuzhang_user_num as is_Install_amount
       ,billamt/chuzhang_user_num as Payment_amount
       ,planedamt/oriallowplanamt as stage_conversion_rate
       ,oriallowplanamt/billamt as installable_amount_rate
       ,er_planedamt/chuzhang_user_num as sec_Install_amount
       ,er_oriallowplanamt/chuzhang_user_num as sec_is_Install_amount
       ,er_billamt/chuzhang_user_num as sec_Payment_amount
       ,er_planedamt/er_oriallowplanamt as sec_Stage_conversion_rate
       ,er_oriallowplanamt/er_billamt as sec_installable_amount_rate
       ,0 as avg_stage
       ,0 as Imp_rate
       ,0 as avg_income
       ,0 as fenqi_amount
from 
(select billdate
       ,sum(planedamt) as planedamt
       ,sum(oriallowplanamt) as oriallowplanamt
       ,sum(billamt) as billamt
       ,count(distinct case when billamt > 0 then pin end) as chuzhang_user_num
       ,sum(case when plantype in ('1','2') then planedamt else 0 end) as er_planedamt
       ,sum(case when plantype in ('1','2') then oriallowplanamt else 0 end) as er_oriallowplanamt
       ,sum(case when plantype in ('1','2') then billamt else 0 end) as er_billamt
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_00
group by billdate) t1
union all
select date1 as dim_day_id
       ,0 as Install_amount
       ,0 as is_Install_amount
       ,0 as Payment_amount
       ,0 as stage_conversion_rate
       ,0 as installable_amount_rate
       ,0 as sec_Install_amount
       ,0 as sec_is_Install_amount
       ,0 as sec_Payment_amount
       ,0 as sec_Stage_conversion_rate
       ,0 as sec_installable_amount_rate
       ,sum(amount*plannum)/sum(amount) as avg_stage  --账单平均分期期数
       ,sum(zhekou_fee)/sum(amount*plannum) as Imp_rate        --账单执行费率
       ,sum(zhekou_fee)/count(distinct pin)  as avg_income
       ,sum(amount) as fenqi_amount
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_01
group by date1) ttt
group by dim_day_id;
);

$SQL_BUFF[3]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d_03;
use dmc_bc;
insert overwrite table dmc_bc.dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d partition (dt)
SELECT dim_day_id     
       ,user_pin                                     
       ,Install_amount              
       ,is_Install_amount             
       ,Payment_amount              
       ,stage_conversion_rate            
       ,installable_amount_rate               
       ,sec_Install_amount               
       ,sec_is_Install_amount               
       ,sec_Payment_amount               
       ,sec_Stage_conversion_rate               
       ,sec_installable_amount_rate               
       ,avg_stage  
       ,Imp_rate
       ,avg_income
       ,fenqi_amount
       ,dim_day_id as dt
FROM dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_bill_acct_indx_i_d_d --明细
;
);

    #############################################################################################
    ########################################以上为SQL编辑区######################################
    #############################################################################################

    return @SQL_BUFF;
}

sub main
{
    my @sql_buff = getsql();

=description
1.串行，数组不赋值
    my @run_idxs = (
);
2.并行:先并行运行0,1,2,4，都成功后并行运行3,5,6，都成功后并行运行7
    my @run_idxs = (
        [0],
        [1,2,3,4,5,6],
        [7],
        [8]
);

=cut

    ##############################################################################################
    ##############################以下为多进程idx编辑区###########################################
    ##############################################################################################
    my @run_idxs = (
        [0,1],
        [2],
        [3]
);
    ##############################################################################################
    ##############################以上为多进程idx编辑区###########################################
    ##############################################################################################


```

#### 1.3 新户表现数据看板

--reverse(split(reverse(key), ',')[0]) as channel_id
```sql

# !/usr/bin/env python
# -*- coding: utf-8 -*-

from template.base_sql_task import *


#
# 目前支持：RUNNER_SPARK_SQL和RUNNER_HIVE
#
sql_runner=RUNNER_HIVE


def get_customized_items():
    """
     if you need some special values in your sql, please define and calculate then here
     to refer it as {YOUR_VAR} in your sql
    """
    today = Time.today()
    TX_PRE_60_DATE = Time.date_sub(date=today, itv=60)
    TX_PRE_365_DATE = Time.date_sub(date=today, itv=365)
    return locals()


sql_map={

     # ATTENTION:   ！！！！ sql_01  因为系统按字典顺序进行排序，小于10 的一定要写成0加编号，否则会顺序混乱，数据出问题，切记，切记！！！！
    "sql_01":"""
--激活用户分渠道以及激活成本
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_01;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_01 as 
select substr(createtime,1,10) as create_time
       ,pin as user_pin
       ,case when source_type2 in ('白条快捷') then 'FastBt'
             else source_id end as source_id
       ,source_price
from dmc_bc.DMCBC_BC_CF_XBT_ACCOUNT_S_D
where dt in ('{TX_DATE}')
and substr(createtime,1,10) between  date_add('{TX_DATE}',-365) and '{TX_DATE}';
    """,

    "sql_02": """
--交易订单匹配手续费成本
use dmc_tmp;

set mapreduce.map.memory.mb=4096;
set mapreduce.map.java.opts=-Xmx3000m;
set mapreduce.reduce.memory.mb=4096;
set mapreduce.reduce.java.opts=-Xmx3000m;

drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_02;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_02 as 
select t1.*
       ,t2.discountamount
from (select *
             ,row_number() over(PARTITION by user_pin order by loan_time asc) as row_num
      from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d
      where dt = '{TX_DATE}'
      and (biz_id not in ('8','9','10','11','12','13','16','23','25','26','32','64','65') or biz_id is null)) t1
left join (select user_pin as pin
                  ,ordr_id as orderid
                  ,prin_camp_amt as discountamount
                  ,prefr_type as type
           from (select *
                       ,row_number() over (partition by ordr_id,coupon_code order by dt desc) as rn
                 from idm.idm_f05_bt_coupon_ordr_i_d) t
                 where rn=1
                 ) t2
on t1.ordr_id=t2.orderid;
    """,
    
        "sql_03": """
--引导页UV
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_03;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_03 as 
select to_date(`timestamp`) as create_time
       ,reverse(split(reverse(key), ',')[0]) as channel_id
       ,count(distinct uuid) as uv
from dmc_bc.DMCBC_BC_INN_SJL_MQ_IN_LOGWRITTER_RING_I_D 
where dt between  date_add('{TX_DATE}',-365) and '{TX_DATE}'
and biz = 'JR,BAITIAO,PS' 
and key like '%SAS_GUIDE_INIT,H5,NEW_GUIDE_PAGE%' 
and to_date(`timestamp`) between  date_add('{TX_DATE}',-365) and '{TX_DATE}'
group by to_date(`timestamp`),reverse(split(reverse(key), ',')[0])
union all
select to_date(dt) as create_time
       ,'FastBt' as channel_id
       ,count(distinct pin) as uv
from dmc_bc.DMCBC_BC_CF_BT_ACTV_FAIL_LOG_I_D
where dt between date_add('{TX_DATE}',-365) and '{TX_DATE}'
and dt<>'2018-01-23'
and (actcode in ('FB_ACT_CODE_0037_80001','FB_ACT_CODE_0037_80006') or (actstep='FB_ACT_STEP_0011' and actcode='FB_ACT_CODE_0037'))
group by to_date(dt)
;
    """,
    
       "sql_04": """
--判断首活以及各阶段活跃表现
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_04;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_04 as 
select create_time
       ,source_id
       ,count(distinct t1.user_pin) as jihuo_renshu  --激活人数
       ,count(distinct t2.user_pin) as huoyue_renshu  --活跃人数
       ,count(distinct case when datediff(t2.loan_time,t1.create_time) <= 0 then t2.user_pin end) as T_0_huoyue_renshu --t0活跃人数
       ,count(distinct case when datediff(t2.loan_time,t1.create_time) <= 29 then t2.user_pin end) as T_30_huoyue_renshu --t30活跃人数
       ,sum(nvl(t2.loan_prin,0)) as shoudan_loan_prin                  --首单交易金额
       ,sum(nvl(t2.shoudan_chengben,0)) as shoudan_chengben    --首单活跃成本
       ,sum(nvl(source_price,0)) as source_price  --激活成本
       ,count(distinct case when t3.user_pin is not null and datediff(t3.loan_time,t2.loan_time) <= 29 then t3.user_pin end) as t_30_shouhuo_fugou --首活后30天内复购人数
       ,count(distinct t3.user_pin) as fugou_renshu
       ,sum(nvl(t3.loan_prin,0)) as fugou_loan_prin
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_01 t1
left join (select user_pin
                  ,loan_prin as loan_prin   --交易金额
                  ,discountamount as shoudan_chengben --首单成本
                  ,loan_time   --首单时间
           from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_02
           where row_num = 1) t2
on t1.user_pin = t2.user_pin
left join (select user_pin
                  ,loan_prin as loan_prin   --交易金额
                  ,discountamount as shoudan_chengben --首单成本
                  ,loan_time   --首单时间
           from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_02
           where row_num = 2) t3
on t1.user_pin = t3.user_pin
group by create_time
       ,source_id;
    """,
    
    
       "sql_05": """    
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_05;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_05 as 
select create_time
       ,source_id
       ,count(distinct case when datediff(t2.loan_time,t1.create_time) between 0 and 89 then t2.user_pin end) as t_90_fenqi_renshu  --t90分期人数
       ,sum(case when datediff(t2.loan_time,t1.create_time) between 0 and 89 then loan_num else 0 end) as t_90_loan_num  --t90分期单量
       ,sum(case when datediff(t2.loan_time,t1.create_time) between 0 and 89 then loan_prin_fenqi else 0 end) as t_90_loan_prin_fenqi  --t90分期交易额
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_01 t1
left join (select substr(loan_time,1,10) as loan_time
                  ,user_pin
                  ,count(distinct loan_id) as loan_num
                  ,sum(loan_prin) as loan_prin_fenqi
           from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_02
           where loan_term > 1 and cnv_time is null
           group by substr(loan_time,1,10) 
                    ,user_pin) t2
on t1.user_pin = t2.user_pin
group by create_time
       ,source_id;

    """,
    
    
    
       "sql_06": """    
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_06;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_06 as 
select substr(create_time,1,10) as create_time
       ,channel_id
       ,sum(uv) as uv
       ,sum(jihuo_renshu) as jihuo_renshu  --激活人数
       ,sum(huoyue_renshu) as huoyue_renshu  --活跃人数
       ,sum(T_0_huoyue_renshu) as T_0_huoyue_renshu --t0活跃人数
       ,sum(T_30_huoyue_renshu) as T_30_huoyue_renshu --t30活跃人数
       ,sum(shoudan_loan_prin) as shoudan_loan_prin                  --首单交易金额
       ,sum(shoudan_chengben) as shoudan_chengben    --首单活跃成本
       ,sum(source_price) as source_price  --激活成本
       ,sum(t_30_shouhuo_fugou) as t_30_shouhuo_fugou --首活后30天内复购人数
       ,sum(fugou_renshu) as fugou_renshu  --复购人数
       ,sum(fugou_loan_prin) as fugou_loan_prin  --复购交易额
       ,sum(t_90_fenqi_renshu) as t_90_fenqi_renshu  --t90分期人数
       ,sum(t_90_loan_num) as t_90_loan_num  --t90分期单量
       ,sum(t_90_loan_prin_fenqi) as t_90_loan_prin_fenqi  --t90分期交易额
from (
select substr(create_time,1,10) as create_time
       ,channel_id
       ,uv
       ,0 as jihuo_renshu  --激活人数
       ,0 as huoyue_renshu  --活跃人数
       ,0 as T_0_huoyue_renshu --t0活跃人数
       ,0 as T_30_huoyue_renshu --t30活跃人数
       ,0 as shoudan_loan_prin                  --首单交易金额
       ,0 as shoudan_chengben    --首单活跃成本
       ,0 as source_price  --激活成本
       ,0 as t_30_shouhuo_fugou --首活后30天内复购人数
       ,0 as fugou_renshu  --复购人数
       ,0 as fugou_loan_prin  --复购交易额
       ,0 as t_90_fenqi_renshu  --t90分期人数
       ,0 as t_90_loan_num  --t90分期单量
       ,0 as t_90_loan_prin_fenqi  --t90分期交易额
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_03
union all
select substr(create_time,1,10) as create_time
       ,source_id as channel_id
       ,0 as uv
       ,jihuo_renshu  --激活人数
       ,huoyue_renshu  --活跃人数
       ,T_0_huoyue_renshu --t0活跃人数
       ,T_30_huoyue_renshu --t30活跃人数
       ,shoudan_loan_prin                  --首单交易金额
       ,shoudan_chengben    --首单活跃成本
       ,source_price  --激活成本
       ,t_30_shouhuo_fugou --首活后30天内复购人数
       ,fugou_renshu  --复购人数
       ,fugou_loan_prin  --复购交易额
       ,0 as t_90_fenqi_renshu  --t90分期人数
       ,0 as t_90_loan_num  --t90分期单量
       ,0 as t_90_loan_prin_fenqi  --t90分期交易额
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_04
union all
select substr(create_time,1,10) as create_time
       ,source_id as channel_id
       ,0 as uv
       ,0 as jihuo_renshu  --激活人数
       ,0 as huoyue_renshu  --活跃人数
       ,0 as T_0_huoyue_renshu --t0活跃人数
       ,0 as T_30_huoyue_renshu --t30活跃人数
       ,0 as shoudan_loan_prin                  --首单交易金额
       ,0 as shoudan_chengben    --首单活跃成本
       ,0 as source_price  --激活成本
       ,0 as t_30_shouhuo_fugou --首活后30天内复购人数
       ,0 as fugou_renshu  --复购人数
       ,0 as fugou_loan_prin  --复购交易额
       ,t_90_fenqi_renshu  --t90分期人数
       ,t_90_loan_num  --t90分期单量
       ,t_90_loan_prin_fenqi  --t90分期交易额
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_05) tt
group by substr(create_time,1,10)
       ,channel_id
;

    """,


    "sql_07": """
use dmc_oa;

insert overwrite table dmc_oa.dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d partition (dt)
select create_time
       ,channel_id
       ,uv
       ,jihuo_renshu  --激活人数
       ,huoyue_renshu  --活跃人数
       ,T_0_huoyue_renshu --t0活跃人数
       ,T_0_huoyue_renshu/jihuo_renshu as t_0_huoyuelv  --t0活跃率
       ,T_30_huoyue_renshu --t30活跃人数
       ,T_30_huoyue_renshu/jihuo_renshu as t_30_huoyuelv  --t30活跃率
       ,shoudan_loan_prin                  --首单交易金额
       ,case when huoyue_renshu = 0 then 0 else shoudan_loan_prin/huoyue_renshu end as shoudan_renjun_jiaoyie  --首单人均交易额
       ,shoudan_chengben    --首单活跃成本
       ,case when huoyue_renshu = 0 then 0 else shoudan_chengben/huoyue_renshu end as shoudan_huoyue_chengben  --首单人均活跃成本
       ,source_price  --激活成本
       ,t_30_shouhuo_fugou --首活后30天内复购人数
       ,case when huoyue_renshu = 0 then 0 else t_30_shouhuo_fugou/huoyue_renshu end as shouhuo_30_fugoulv  --首活30天内复购率
       ,case when fugou_renshu = 0 then 0 else fugou_loan_prin/fugou_renshu end as fugou_renjun_jiaoyie  --复购人均交易额
       ,fugou_renshu  --复购人数
       ,fugou_loan_prin  --复购交易额
       ,t_90_fenqi_renshu  --t90分期人数
       ,case when jihuo_renshu = 0 then 0 else t_90_fenqi_renshu/jihuo_renshu end as t90_fenqilv  --t90分期率
       ,t_90_loan_num  --t90分期单量
       ,t_90_loan_prin_fenqi  --t90分期交易额
       ,case when t_90_loan_num = 0 then 0 else t_90_loan_prin_fenqi/t_90_loan_num end as t90_danjun_fenqijiaoyie  --t90单均分期交易额
       ,create_time as dt
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_new_acct_tab_data_i_d_06;

    """,
    

}


# 以下部分无需改动，除非作业有特殊要求
sql_task = SqlTask()
sql_task.set_sql_runner(sql_runner)
sql_task.set_customized_items(get_customized_items())
return_code = sql_task.execute_sqls(sql_map)
exit(return_code)```



#### 1.4 白条渗透率分场景

```sql
# !/usr/bin/env python
# -*- coding: utf-8 -*-

from template.base_sql_task import *


#
# 目前支持：RUNNER_SPARK_SQL和RUNNER_HIVE
#
sql_runner=RUNNER_HIVE


def get_customized_items():
    """
     if you need some special values in your sql, please define and calculate then here
     to refer it as {YOUR_VAR} in your sql
    """
    today = Time.today()
    TX_PRE_60_DATE = Time.date_sub(date=today, itv=60)
    TX_PRE_365_DATE = Time.date_sub(date=today, itv=365)
    return locals()


sql_map={

     # ATTENTION:   ！！！！ sql_01  因为系统按字典顺序进行排序，小于10 的一定要写成0加编号，否则会顺序混乱，数据出问题，切记，切记！！！！
    "sql_01":"""
--商城场景订单明细
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_01;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_01 as 
select
  sale_ord_dt as sale_ord_dt
  ,case when t2.ordr_id is not null then '白条' else '非白条' end as zhifu_type
  ,user_log_acct as user_pin
  ,parent_sale_ord_id as order_id
  ,user_actual_pay_amount as amount
from (select substr(sale_ord_dt,1,10) as sale_ord_dt
             ,user_log_acct
             ,parent_sale_ord_id
             ,sum(user_actual_pay_amount) as user_actual_pay_amount
      from idm.IDM_M04_JDMALL_SALE_ORDR_M04_SUM_DTL_I_D  
      where dt>= trunc('{TX_DATE}','MM') 
      and sale_ord_dt between trunc('{TX_DATE}','MM') and '{TX_DATE}'
      and sale_ord_valid_flag=1
      group by substr(sale_ord_dt,1,10)
             ,user_log_acct
             ,parent_sale_ord_id) t1
left join (select ordr_id
            from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d
            where dt = '{TX_DATE}'
            and substr(loan_time,1,10) between trunc('{TX_DATE}','MM') and '{TX_DATE}' ) t2
on t1.parent_sale_ord_id =t2.ordr_id;
    """,

    "sql_02": """
--外单场景订单明细
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_02;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_02 as 
select substr(pay_succ_time,1,10) as sale_ord_dt
       ,case when pi_type_code='JIOU' then '白条' else '非白条' end as zhifu_type
       ,user_pin
       ,out_trade_no as order_id
       ,sum(pay_amt) as amount
from idm.idm_f02_pay_wd_tx_ordr_dtl_i_d
where dt>= trunc('{TX_DATE}','MM') 
and substr(pay_succ_time,1,10) between trunc('{TX_DATE}','MM') and '{TX_DATE}'
and scene_type='out'
group by substr(pay_succ_time,1,10)
         ,case when pi_type_code='JIOU' then '白条' else '非白条' end
         ,user_pin
         ,out_trade_no;
    """,
    
        "sql_03": """
--金融场景订单明细
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_03;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_03 as 
select t1.user_pin
        ,dat
        ,biz_nm1
        ,biz_nm2
        ,biz_nm3
        ,ordr_id
        ,ordr_amt
        ,lag(dat,1) over (partition by t1.user_pin order by dat) as lag_dt
     from
        (select 
            dim_day_dt as dat
            ,biz_nm1
            ,biz_nm2
            ,biz_nm3
            ,user_pin
            ,ordr_id
            ,ordr_amt
        from dmc_oa.dmcoa_zhgl_nyc_model_trans_inn_otr_s_d
        where channel_type='平台' and dt= '{TX_DATE}'
        and substr(dim_day_dt,1,10) between trunc('{TX_DATE}','MM') and '{TX_DATE}'
        --and biz_nm1!='支付（CSU）'
        --and dim_day_dt>='2018-01-01' 
        union all
        select 
            substr(pay_time,1,10) as dat
            ,'新消费平台' as biz_nm1
            ,'优享免息' as biz_nm2
            ,'' as biz_nm3
            ,user_pin as user_pin
            ,ordr_id
            ,user_actual_pay_amount as ordr_amt
        from 
        (select *,cast(parent_sale_ordr_id as string) as ordr_id
          FROM (
          select *,row_number() over(partition by parent_sale_ordr_id,user_pin order by pay_time desc) as rn
          from (
            	select parent_sale_ordr_id, after_prefr_amt, user_pin, sale_ordr_id,item_sku_id, coalesce(pay_succ_time, chk_acct_time, '') as pay_time
          	from idm.idm_f02_ncp_yxmx_ordr_dtl_i_d 
          	where coalesce(pay_succ_time, chk_acct_time, '') <> '' 
          	and sale_ordr_valid_flag = 1
          	and ordr_from in ('yxmx-kpl'))  t1
          ) t2
          where rn = 1  --这是个增量表
          and substr(pay_time,1,10) between trunc('{TX_DATE}','MM') and '{TX_DATE}') t1
        inner join
        (select substr(sale_ord_dt,1,10) as sale_ord_dt
             ,user_log_acct
             ,parent_sale_ord_id
             ,sum(user_actual_pay_amount) as user_actual_pay_amount
      from idm.IDM_M04_JDMALL_SALE_ORDR_M04_SUM_DTL_I_D  
      where dt>= trunc('{TX_DATE}','MM') 
      and substr(sale_ord_dt,1,10) between trunc('{TX_DATE}','MM')  and '{TX_DATE}'
      and sale_ord_valid_flag=1
      group by substr(sale_ord_dt,1,10)
             ,user_log_acct
             ,parent_sale_ord_id) t2
       on t1.ordr_id = t2.parent_sale_ord_id
        union all
        select 
            cast(dat as string)
            ,'码支付' as biz_nm1
            ,'码支付' as biz_nm2
            ,'' as biz_nm3
            ,pin as user_pin
            ,orderid as ordr_id
            ,ordr_amt
        from
            (select 
                to_date(create_time) as dat,
                user_pin as pin,
                mercht_ordr_id as orderid
                ,pay_amt as ordr_amt
            from idm.idm_f02_pay_wd_trade_ordr_i_d
            where 
                substr(create_time,1,10) between trunc('{TX_DATE}','MM') and '{TX_DATE}'
                and 
                ordr_stat = 2
                and pay_tx_typ = 'GEN'
                and upper(trad_src) like '%_JR_%'
                and mercht_no!='110617365001'
            union all
            select to_date(create_time) as dat,
                   user_pin as pin ,
                   mercht_ordr_id as orderid
                   ,ordr_amt as ordr_amt
            from idm.idm_f02_pay_yl_trade_ordr_i_d
            where substr(create_time,1,10) between trunc('{TX_DATE}','MM') and '{TX_DATE}'
            and prod_typ in ('UNPQRPAY','UNPQRSCAN')
            and ordr_stat = 2
            and upper(trad_src) like '%_JR_%'
            union all
            select 
                to_date(ordr_cmplt_time) as dat,
                cust_login_name as pin,
                out_trade_no as orderid
                ,pay_amt as ordr_amt
            from idm.idm_f02_pay_js_trade_ordr_i_d
            where 
                substr(ordr_cmplt_time,1,10) between trunc('{TX_DATE}','MM') and '{TX_DATE}'
                and 
                ordr_cmplt_time is not null
                and ordr_stat in ('FINI','REFU')
                and sub_trad_typ in('SALE','COLT')
                and upper(ordr_recv_chnl) like '%_JR_%'
                and prod_typ in     ('UNPQRPAY',
                                    'JDPAY02SYS',
                                    'UNPQRSCAN',
                                    'UNPQRJH',
                                    'JDPAY02FKM',
                                    'SUBWAYPAY',
                                    'QRPAY',
                                    'JDPAY02PCSYS',
                                    'SCANCODE',
                                    'FACEPAY',
                                    'CPPAYX',
                                    'NUCCFKM',
                                    'NUCCSYS',
                                    'JD-UNION-PAY',
                                    'JDBTPAY'
                                    )
            ) t
        ) t1
    left semi join idm.idm_f03_app_jrapp_user_actv_dtl_i_d t5 on t1.user_pin=t5.user_pin and t1.dat=t5.dt;
    """,
    
       "sql_04": """
--金融场景订单明细
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_04;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_04 as 
select substr(dat,1,10) as sale_ord_dt
       ,case when t2.ordr_id is not null then '白条' else '非白条' end as zhifu_type
       ,t1.user_pin
       ,t1.ordr_id as order_id
       ,sum(ordr_amt) as amount
from 
(select *
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_03
where (biz_nm1 in ('码支付','新消费平台','用户中心','众筹业务') or (biz_nm1 in ('支付（CSU）') and biz_nm3 in ('话费充值','流量充值','水电煤')))) t1
left join (select *  
           from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d t
           where dt = '{TX_DATE}'
           and (biz_id not in ('8','9','10','11','12','13','16','23','25','26') or biz_id is null)
           ) t2
on t1.ordr_id = t2.ordr_id
group by substr(dat,1,10)
       ,case when t2.ordr_id is not null then '白条' else '非白条' end
       ,t1.user_pin
       ,t1.ordr_id;
    """,
    
    
       "sql_05": """    
use dmc_tmp;
drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_05;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_05 as 
select '{TX_DATE}' as dim_day
       ,'商城' as pord_type
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' then user_pin end) as rihuo_all
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then user_pin end) as rihuo_bt
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' then order_id end) as riddl_all
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then order_id end) as riddl_bt
       ,sum(case when sale_ord_dt = '{TX_DATE}' then amount else 0 end) as rijye_all
       ,sum(case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then amount else 0 end) as rijye_bt
       ,count(distinct user_pin) as yuehuo_all
       ,count(distinct case when zhifu_type in ('白条') then user_pin end) as yuehuo_bt
       ,count(distinct order_id) as yueddl_all
       ,count(distinct case when zhifu_type in ('白条') then order_id end) as yueddl_bt
       ,sum(amount) as yuejye_all
       ,sum(case when zhifu_type in ('白条') then amount else 0 end) as yuejye_bt
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_01 
union all
select '{TX_DATE}' as dim_day
       ,'外单' as pord_type
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' then user_pin end) as rihuo_all
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then user_pin end) as rihuo_bt
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' then order_id end) as riddl_all
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then order_id end) as riddl_bt
       ,sum(case when sale_ord_dt = '{TX_DATE}' then amount else 0 end) as rijye_all
       ,sum(case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then amount else 0 end) as rijye_bt
       ,count(distinct user_pin) as yuehuo_all
       ,count(distinct case when zhifu_type in ('白条') then user_pin end) as yuehuo_bt
       ,count(distinct order_id) as yueddl_all
       ,count(distinct case when zhifu_type in ('白条') then order_id end) as yueddl_bt
       ,sum(amount) as yuejye_all
       ,sum(case when zhifu_type in ('白条') then amount else 0 end) as yuejye_bt
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_02
union all
select '{TX_DATE}' as dim_day
       ,'金融' as pord_type
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' then user_pin end) as rihuo_all
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then user_pin end) as rihuo_bt
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' then order_id end) as riddl_all
       ,count(distinct case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then order_id end) as riddl_bt
       ,sum(case when sale_ord_dt = '{TX_DATE}' then amount else 0 end) as rijye_all
       ,sum(case when sale_ord_dt = '{TX_DATE}' and zhifu_type in ('白条') then amount else 0 end) as rijye_bt
       ,count(distinct user_pin) as yuehuo_all
       ,count(distinct case when zhifu_type in ('白条') then user_pin end) as yuehuo_bt
       ,count(distinct order_id) as yueddl_all
       ,count(distinct case when zhifu_type in ('白条') then order_id end) as yueddl_bt
       ,sum(amount) as yuejye_all
       ,sum(case when zhifu_type in ('白条') then amount else 0 end) as yuejye_bt
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_04;

    """,


    "sql_06": """
use dmc_oa;

insert overwrite table dmc_oa.dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d partition (dt= '{TX_DATE}')
select dim_day
       ,pord_type
       ,rihuo_all
       ,rihuo_bt
       ,rihuo_bt/rihuo_all as rihuo_bt_shentoulv
       ,riddl_all
       ,riddl_bt
       ,riddl_bt/riddl_all as riddl_bt_shentoulv
       ,rijye_all
       ,rijye_bt
       ,rijye_bt/rijye_all as rijye_bt_shentoulv
       ,yuehuo_all
       ,yuehuo_bt
       ,yuehuo_bt/yuehuo_all as yuehuo_bt_shentoulv
       ,yueddl_all
       ,yueddl_bt
       ,yueddl_bt/yueddl_all as yueddl_bt_shentoulv
       ,yuejye_all
       ,yuejye_bt
       ,yuejye_bt/yuejye_all as yuejye_bt_shentoulv
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_baitiao_data_rate_i_d_05;

    """,
    

}


# 以下部分无需改动，除非作业有特殊要求
sql_task = SqlTask()
sql_task.set_sql_runner(sql_runner)
sql_task.set_customized_items(get_customized_items())
return_code = sql_task.execute_sqls(sql_map)
exit(return_code)
```



#### 1.5 白条渠道质量监控-渠道分类[注意汇总方法]
```sql
#!/usr/bin/perl
########################################################################################################################
#  Creater        :gaochao
#  Creation Time  :2019-05-14
#  Description    :渠道质量指标监控
#  Modify By      :
#  Modify Time    :
#  Modify Content :
#  Script Version :1.0.0
########################################################################################################################
use strict;
use jrjtcommon;
use un_pswd;
use Common::Hive;
use Parallel::ForkManager;

my $MAX_CONCURRENT = 5;
my %rc_hash = ();

##############################################
#默认STINGER运行，失败后HIVE运行，可更改Runner和Retry_Runner
#修改最终生成表库名和表名
##############################################
my $Runner = "HIVE";
my $Retry_Runner = "HIVE";
my $DB = "";
my $TABLE = "";
##############################################

if ( $#ARGV < 0 ) { exit(1); }
my $CONTROL_FILE = $ARGV[0];
my $SYS = substr(${CONTROL_FILE}, 0, 3);
my $JOB = substr(${CONTROL_FILE}, 4, length(${CONTROL_FILE})-17);

print $CONTROL_FILE;
#当日 yyyy-mm-dd
my $TX_DATE = substr(${CONTROL_FILE},length(${CONTROL_FILE})-12, 4).'-'.substr(${CONTROL_FILE},length(${CONTROL_FILE})-8, 2).'-'.substr(${CONTROL_FILE},length(${CONTROL_FILE})-6, 2);

my $TXDATE = substr($TX_DATE, 0, 4).substr($TX_DATE, 5, 2).substr($TX_DATE, 8, 2);                        #当日 yyyymmdd
my $PERIOD = 365;
my $TX_MONTH = substr($TX_DATE, 0, 4).'-'.substr($TX_DATE, 5, 2);                                          #当日所在月 yyyy-mm

#my $TXMONTH = substr($TX_DATE, 0, 4).substr($TX_DATE, 5, 2);                                               #当日所在月 yyyymm
#my $TX_PREV_DATE = getPreviousDate($TX_DATE);                                                               #前一天 yyyy-mm-dd
#my $TX_NEXT_DATE = getNextDate($TX_DATE);                                                                   #下一天 yyyy-mm-dd
#my $TXPDATE = substr(${TX_PREV_DATE},0,4).substr(${TX_PREV_DATE},5,2).substr(${TX_PREV_DATE},8,2);        #前一天 yyyymmdd
#my $TXNDATE = substr(${TX_NEXT_DATE},0,4).substr(${TX_NEXT_DATE},5,2).substr(${TX_NEXT_DATE},8,2);        #下一天 yyyymmdd

my $TX_PREV_DATE = getPreviousDate($TX_DATE);                                                               #前一天 yyyy-mm-dd
my $TX_NEXT_DATE = getNextDate($TX_DATE);                                                                   #下一天 yyyy-mm-dd
my $TXPDATE = substr(${TX_PREV_DATE},0,4).substr(${TX_PREV_DATE},5,2).substr(${TX_PREV_DATE},8,2);        #前一天 yyyymmdd
my $TXNDATE = substr(${TX_NEXT_DATE},0,4).substr(${TX_NEXT_DATE},5,2).substr(${TX_NEXT_DATE},8,2);        #下一天 yyyymmdd
my $CURRENT_TIME = getNowTime();
my $TX_YEAR = substr($TX_DATE, 0, 4);                                                                      #当年 yyyy
my $TX_MONTH_FIRSTDAY = substr($TX_DATE, 0, 4).'-'.substr($TX_DATE, 5, 2).'-01';                           #月度第一天
my $TX_YEAR_FIRSTDAY = substr($TX_DATE, 0, 4).'-01-01';                                                    #年度第一天
my $TX_QUARTER_FIRSTDAY = substr($TX_DATE, 0, 4).'-'.substr("0".(int(substr($TX_DATE, 5, 2)/3.1)*3+1),-2,2).'-01'; #季度第一天


########################################################################################################################
# Write SQL For Your APP
sub getsql
{
    my @SQL_BUFF=();
    #########################################################################################
    ####################################以下为SQL编辑区######################################
    #########################################################################################
$SQL_BUFF[0]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_00;
use dmc_tmp;

--激活用户分渠道以及激活成本
drop table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_00;
create table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_00 as 
select substr(createtime,1,10) as create_time
       ,pin as user_pin
       ,case when source_type2 in ('白条快捷') then 'FastBt'
             else source_id end as source_id
       ,source_price
from dmc_bc.DMCBC_BC_CF_XBT_ACCOUNT_S_D
where dt in ('$TX_DATE')
and substr(createtime,1,10) between  date_add('$TX_DATE',-365) and '$TX_DATE';
);

$SQL_BUFF[1]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_01;
use dmc_tmp;

set mapreduce.map.memory.mb=4096;
set mapreduce.map.java.opts=-Xmx3000m;
set mapreduce.reduce.memory.mb=4096;
set mapreduce.reduce.java.opts=-Xmx3000m;

--交易订单匹配手续费成本
drop table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_01;
create table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_01 as 
select t1.*
       ,t2.discountamount
from (select *
             ,row_number() over(PARTITION by user_pin order by loan_time asc) as row_num
      from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d
      where dt = '$TX_DATE'
      and (biz_id not in ('8','9','10','11','12','13','16','23','25','26','32','64','65') or biz_id is null)) t1
left join (select user_pin as pin
                  ,ordr_id as orderid
                  ,prin_camp_amt as discountamount
                  ,prefr_type as type
           from (select *
                       ,row_number() over (partition by ordr_id,coupon_code order by dt desc) as rn
                 from idm.idm_f05_bt_coupon_ordr_i_d) t
                 where rn=1
                 ) t2
on t1.ordr_id=t2.orderid;
);


$SQL_BUFF[2]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_02;
use dmc_tmp;


set mapreduce.map.memory.mb=4096;
set mapreduce.map.java.opts=-Xmx3000m;
set mapreduce.reduce.memory.mb=4096;
set mapreduce.reduce.java.opts=-Xmx3000m;

--人均交易额、活跃率 、成本等
drop table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_02;
create table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_02 as 
select create_time
       ,source_id
       ,count(distinct t1.user_pin) as jihuo_renshu  --激活人数
       ,count(distinct t2.user_pin) as huoyue_renshu  --活跃人数
       ,count(distinct case when datediff(t2.loan_time,t1.create_time) <= 29 then t2.user_pin end) as T_30_huoyue_renshu --t30活跃人数
       ,count(distinct case when datediff(t2.loan_time,t1.create_time) <= 89 then t2.user_pin end) as T_90_huoyue_renshu --t90活跃人数
       ,count(distinct case when datediff(t3.loan_time,t1.create_time) <= 89 then t3.user_pin end) as T_90_erdan_huoyue_renshu --t90二单及以上单量活跃人数
       ,sum(nvl(t2.loan_prin,0)) as loan_prin                  --首单交易金额
       ,sum(nvl(t2.shoudan_chengben,0)) as shoudan_chengben    --首单活跃成本
       ,sum(nvl(source_price,0)) as source_price  --激活成本
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_00 t1
left join (select user_pin
                  ,loan_prin as loan_prin   --交易金额
                  ,discountamount as shoudan_chengben --首单成本
                  ,loan_time   --首单时间
           from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_01
           where row_num = 1) t2
on t1.user_pin = t2.user_pin
left join (select user_pin
                  ,loan_prin as loan_prin   --交易金额
                  ,discountamount as shoudan_chengben --首单成本
                  ,loan_time   --首单时间
           from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_01
           where row_num = 2) t3
on t1.user_pin = t3.user_pin
group by create_time
       ,source_id;

);
    

$SQL_BUFF[3]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_03;
use dmc_tmp;

--引导页UV

drop table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_03;
create table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_03 as 
select to_date(`timestamp`) as create_time
       ,reverse(split(reverse(key), ',')[0]) as channel_id
       ,count(distinct uuid) as uv
from odm.ODM_INN_SJL_MQ_IN_LOGWRITTER_RING_I_D 
where dt between  date_add('$TX_DATE',-365) and '$TX_DATE'
and biz = 'JR,BAITIAO,PS' 
and key like '%SAS_GUIDE_INIT,H5,NEW_GUIDE_PAGE%' 
and to_date(`timestamp`) between  date_add('$TX_DATE',-365) and '$TX_DATE'
group by to_date(`timestamp`),reverse(split(reverse(key), ',')[0])
union all
select to_date(dt) as create_time
       ,'FastBt' as channel_id
       ,count(distinct pin) as uv
from odm.ODM_CF_ACTV_FAIL_LOG_I_D
where dt between date_add('$TX_DATE',-365) and '$TX_DATE'
and dt<>'2018-01-23'
and (actcode in ('FB_ACT_CODE_0037_80001','FB_ACT_CODE_0037_80006') or (actstep='FB_ACT_STEP_0011' and actcode='FB_ACT_CODE_0037'))
group by to_date(dt)
;
);

$SQL_BUFF[4]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_04;
use dmc_tmp;

set mapreduce.map.memory.mb=4096;
set mapreduce.map.java.opts=-Xmx3000m;
set mapreduce.reduce.memory.mb=4096;
set mapreduce.reduce.java.opts=-Xmx3000m;

--T90核心客户占比

drop table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_04;
create table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_04 as 
select t1.create_time
       ,t1.source_id
       ,count(distinct case when datediff(t2.created_date,t1.create_time) between 0 and 89 then t2.user_pin end) as hexin_jiaoyi
       ,sum(case when datediff(t2.created_date,t1.create_time) between 0 and 89 then cnsm_amount else 0 end) as cnsm_amount    --暂时无意义
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_00 t1
left join (select substr(created_date,1,10) as created_date
                  ,user_pin
                 -- ,sum(case when pord_type in ('消费不分期') then 0 else cnsm_amount end) as hexin_jiaoyi
                  ,sum(cnsm_amount) as cnsm_amount
           from dmc_bc.dmcbc_xfjr_cf_xbt_user_behavior_dtl_s_m
           where dt in ('$TX_DATE')
           and substr(created_date,1,10) between date_add('$TX_DATE',-365) and '$TX_DATE'
           and pord_type not in ('借钱','买单侠','消费不分期')
           group by substr(created_date,1,10)
                  ,user_pin) t2
on t1.user_pin = t2.user_pin
group by t1.create_time
       ,t1.source_id;
);



$SQL_BUFF[5]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_05;
use dmc_tmp;

set mapreduce.map.memory.mb=4096;
set mapreduce.map.java.opts=-Xmx3000m;
set mapreduce.reduce.memory.mb=4096;
set mapreduce.reduce.java.opts=-Xmx3000m;

--变现率和留存率

drop table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_05;
create table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_05 as 
select t1.create_time
       ,t1.source_id
       ,sum(case when datediff(t2.created_date,t1.create_time) between 0 and 89 then cnsm_amount else 0 end) as T_90_cnsm_amount    --90天内交易额
       ,sum(case when datediff(t2.created_date,t1.create_time) between 0 and 89 then yushou_shouru else 0 end) as T_90_yushou_shouru    --90天内收入
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_00 t1
left join (select substr(created_date,1,10) as created_date
                  ,user_pin
                 -- ,sum(case when pord_type in ('消费不分期') then 0 else cnsm_amount end) as hexin_jiaoyi
                  ,sum(cnsm_amount) as cnsm_amount
                  ,sum(yushou_shouru) as yushou_shouru
           from dmc_bc.dmcbc_xfjr_cf_xbt_user_behavior_dtl_s_m
           where dt in ('$TX_DATE')
           and substr(created_date,1,10) between date_add('$TX_DATE',-365) and '$TX_DATE'
           and pord_type not in ('借钱','买单侠','金条')
           group by substr(created_date,1,10)
                  ,user_pin) t2
on t1.user_pin = t2.user_pin
group by t1.create_time
       ,t1.source_id;
);



$SQL_BUFF[6]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_06;
use dmc_tmp;

set mapreduce.map.memory.mb=4096;
set mapreduce.map.java.opts=-Xmx3000m;
set mapreduce.reduce.memory.mb=4096;
set mapreduce.reduce.java.opts=-Xmx3000m;
--基础数据汇总
drop table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_06;
create table dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_06 as 
select create_time
       ,source_id
       ,sum(jihuo_renshu) as jihuo_renshu  --激活人数
       ,sum(huoyue_renshu) as huoyue_renshu  --活跃人数
       ,sum(T_30_huoyue_renshu)  as T_30_huoyue_renshu --t30活跃人数
       ,sum(T_90_huoyue_renshu) as T_90_huoyue_renshu  --t90活跃人数
       ,sum(T_90_erdan_huoyue_renshu) as T_90_erdan_huoyue_renshu --t90二单及以上单量活跃人数
       ,sum(loan_prin) as loan_prin                  --首单交易金额
       ,sum(shoudan_chengben) as shoudan_chengben    --首单活跃成本
       ,sum(source_price) as source_price  --激活成本
       ,sum(uv) as uv
       ,sum(hexin_jiaoyi) as hexin_jiaoyi
       ,sum(cnsm_amount) as cnsm_amount
       ,sum(T_90_cnsm_amount) as T_90_cnsm_amount
       ,sum(T_90_yushou_shouru) as T_90_yushou_shouru
       ,sum(niandu_jihuo_renshu) as niandu_jihuo_renshu
       ,sum(niandu_huoyue_renshu) as niandu_huoyue_renshu
from (
select create_time
       ,source_id
       ,jihuo_renshu  --激活人数
       ,huoyue_renshu  --活跃人数
       ,T_30_huoyue_renshu --t30活跃人数
       ,T_90_huoyue_renshu  --t90活跃人数
       ,T_90_erdan_huoyue_renshu  --t90二单及以上单量活跃人数
       ,loan_prin                  --首单交易金额
       ,shoudan_chengben    --首单活跃成本
       ,source_price  --激活成本
       ,0 as uv
       ,0 as hexin_jiaoyi
       ,0 as cnsm_amount
       ,0 as T_90_cnsm_amount
       ,0 as T_90_yushou_shouru
       ,0 as niandu_jihuo_renshu
       ,0 as niandu_huoyue_renshu
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_02
union all
select substr(create_time,1,10) as create_time
       ,channel_id as source_id
       ,0 as jihuo_renshu  --激活人数
       ,0 as huoyue_renshu  --活跃人数
       ,0 as T_30_huoyue_renshu --t30活跃人数
       ,0 as T_90_huoyue_renshu  --t90活跃人数
       ,0 as T_90_erdan_huoyue_renshu  --t90二单及以上单量活跃人数
       ,0 as loan_prin                  --首单交易金额
       ,0 as shoudan_chengben    --首单活跃成本
       ,0 as source_price  --激活成本
       ,uv
       ,0 as hexin_jiaoyi
       ,0 as cnsm_amount
       ,0 as T_90_cnsm_amount
       ,0 as T_90_yushou_shouru
       ,0 as niandu_jihuo_renshu
       ,0 as niandu_huoyue_renshu
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_03
union all
select create_time
       ,source_id
       ,0 as jihuo_renshu  --激活人数
       ,0 as huoyue_renshu  --活跃人数
       ,0 as T_30_huoyue_renshu --t30活跃人数
       ,0 as T_90_huoyue_renshu  --t90活跃人数
       ,0 as T_90_erdan_huoyue_renshu  --t90二单及以上单量活跃人数
       ,0 as loan_prin                  --首单交易金额
       ,0 as shoudan_chengben    --首单活跃成本
       ,0 as source_price  --激活成本
       ,0 as uv
       ,hexin_jiaoyi
       ,cnsm_amount
       ,0 as T_90_cnsm_amount
       ,0 as T_90_yushou_shouru
       ,0 as niandu_jihuo_renshu
       ,0 as niandu_huoyue_renshu
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_04
union all
select create_time
       ,source_id
       ,0 as jihuo_renshu  --激活人数
       ,0 as huoyue_renshu  --活跃人数
       ,0 as T_30_huoyue_renshu --t30活跃人数
       ,0 as T_90_huoyue_renshu  --t90活跃人数
       ,0 as T_90_erdan_huoyue_renshu  --t90二单及以上单量活跃人数
       ,0 as loan_prin                  --首单交易金额
       ,0 as shoudan_chengben    --首单活跃成本
       ,0 as source_price  --激活成本
       ,0 as uv
       ,0 as hexin_jiaoyi
       ,0 as cnsm_amount
       ,T_90_cnsm_amount
       ,T_90_yushou_shouru
       ,0 as niandu_jihuo_renshu
       ,0 as niandu_huoyue_renshu
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_05
union all
select '$TX_DATE' as create_time
       ,source_id
       ,0 as jihuo_renshu  --激活人数
       ,0 as huoyue_renshu  --活跃人数
       ,0 as T_30_huoyue_renshu --t30活跃人数
       ,0 as T_90_huoyue_renshu  --t90活跃人数
       ,0 as T_90_erdan_huoyue_renshu  --t90二单及以上单量活跃人数
       ,0 as loan_prin                  --首单交易金额
       ,0 as shoudan_chengben    --首单活跃成本
       ,0 as source_price  --激活成本
       ,0 as uv
       ,0 as hexin_jiaoyi
       ,0 as cnsm_amount
       ,0 as T_90_cnsm_amount
       ,0 as T_90_yushou_shouru
       ,sum(jihuo_renshu) as niandu_jihuo_renshu
       ,sum(huoyue_renshu) as niandu_huoyue_renshu
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_02
where substr(create_time,1,4) = '$TX_YEAR'
group by source_id) tt
group by create_time
       ,source_id;    
);


$SQL_BUFF[7]=qq(
set mapred.job.name=dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_07;
use dmc_bc;
insert overwrite table dmc_bc.dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d partition (dt)
select create_time
       ,'-' as user_pin
       ,source_id
       ,jihuo_renshu  --激活人数
       ,huoyue_renshu  --活跃人数
       ,T_30_huoyue_renshu --t30活跃人数
       ,loan_prin                  --首单交易金额
       ,shoudan_chengben    --首单活跃成本
       ,source_price  --激活成本
       ,uv
       ,hexin_jiaoyi
       ,cnsm_amount
       ,jihuo_renshu/uv as chuantou_zhuanhualv  --穿透转化率
       ,loan_prin/jihuo_renshu as jihuo_renjun_shoudan_jiaoyie  --激活口径人均首单交易额
       ,loan_prin/huoyue_renshu as huoyue_renjun_shoudan_jiaoyie  --活跃口径人均首单交易额
       ,T_30_huoyue_renshu/jihuo_renshu as T_30_shouhuolv  --T30首活率
       ,hexin_jiaoyi/jihuo_renshu as T_90_hexin_jiaoyi_zhanbi  --T30核心交易占比
       ,source_price/jihuo_renshu as renjun_jihuo_chengben  --人均激活成本
       ,shoudan_chengben/jihuo_renshu as jihuo_renjun_shouhuo_chengben  --激活口径人均首活成本
       ,shoudan_chengben/huoyue_renshu as huoyue_renjun_shouhuo_chengben  --活跃口径人均首活成本
       ,T_90_huoyue_renshu  --t90活跃人数
       ,T_90_erdan_huoyue_renshu  --t90二单及以上单量活跃人数
       ,T_90_cnsm_amount  --90天内交易额
       ,T_90_yushou_shouru  --90天内收入
       ,niandu_jihuo_renshu  --年度激活量
       ,niandu_huoyue_renshu  --年度激活对应的新增活跃量
       ,T_90_erdan_huoyue_renshu/T_90_huoyue_renshu as liucunlv  --留存率
       ,T_90_yushou_shouru/T_90_cnsm_amount as bianxianlv  --变现率
       ,create_time as dt
from dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_chnl_qlty_indx_i_d_06;

);

    #############################################################################################
    ########################################以上为SQL编辑区######################################
    #############################################################################################

    return @SQL_BUFF;
}

sub main
{
    my @sql_buff = getsql();

=description
1.串行，数组不赋值
    my @run_idxs = (
    );
2.并行:先并行运行0,1,2,4，都成功后并行运行3,5,6，都成功后并行运行7
    my @run_idxs = (
        [0],
        [1,2,3,4,5,6],
        [7],
        [8],
        [9]
    );

=cut

    ##############################################################################################
    ##############################以下为多进程idx编辑区###########################################
    ##############################################################################################
    my @run_idxs = (
        [0,1],
		[2,3,4,5],
		[6],
		[7]
    );
    ##############################################################################################
    ##############################以上为多进程idx编辑区###########################################
    ##############################################################################################


    unless (@run_idxs) {
        for (my $i=0; $i <= $#sql_buff; $i++) {
            $run_idxs[$i][0] = $i;
        }
    }

    for my $i (0 ..$#run_idxs) {
        my @parallel_list = ();
        for my $j (0 .. $#{$run_idxs[$i]}) {
            push(@parallel_list, $run_idxs[$i][$j]);
        }
        &execute_sql_paralle(\@sql_buff, \@parallel_list);

        if (%rc_hash) {
            foreach my $key (keys %rc_hash) {
                print "$key Failed\n";
            }
            return 1;
        }
    }

    return 0;
}


########################################################################################################################

sub execute_sql_paralle
{
    my ($sqls, $idxs) = @_;

    my @sql_buff = @$sqls;
    my @run_idxs = @$idxs;

    my $pm = Parallel::ForkManager->new($MAX_CONCURRENT);
    $pm->run_on_start( sub {
        my ($pid, $ident)=@_;
        print "**** $ident started, pid: $pid\n";
    });
    $pm->run_on_wait(sub {
            #            print "***** wait for children ...\n"
        },
        0.5,
    );

    $pm->run_on_finish( sub {
        my ($pid, $exit_code, $ident) = @_;
        print "run_on_finish: $ident (pid: $pid) exited with code: [$exit_code]\n";
        if ($exit_code != 0) {
            $rc_hash{$ident} = $exit_code;
        }
    });

    for (my $i = 0; $i <= $#sql_buff; $i++) {
        unless (grep {$_ eq $i} @run_idxs) { next; }
        my $pid = $pm->start("SQL_BUFF[$i]") and next;
        my $ret = Common::Hive::run_hive_sql($sql_buff[$i], ${Runner}, ${Retry_Runner});
        $pm->finish($ret);
    }
    $pm->wait_all_childs;

}


########################################################################################################################
# program section
# To see if there is one parameter,
print getCurrentDateTime(" Startup Success ..");
print "SYS          : $SYS\n";
print "JOB          : $JOB\n";
print "TX_DATE      : $TX_DATE\n";
print "TXDATE       : $TXDATE\n";
print "Target TABLE : $TABLE\n";

my $rc = main();
if ( $rc != 0 ) {
    print getCurrentDateTime("Task Execution Failed"),"\n";
}
else{
    print getCurrentDateTime("Task Execution Success"),"\n";
}
exit($rc);```




# Get

### 疑问：
账单表 plantype 具体含义

ODM.ODM_CF_BILL_DETAIL_0000_S_D --and plantype in ('2','3','4')
plantype



 ### 1.取用户首单最新状态 或者历史状态
还是用sdm小白条方便，可以看到某一个特定时间分区的用户首单状态
-思路：用row_number对用户订单排序来找到首单
```sql
select t.*
        ,row_number() over(PARTITION by user_pin order by loan_time asc) as is_first_pai
 from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d t
 where dt = '{TX_DATE}'
 and (biz_id not in ('8','9','10','11','12','13','16','23','25','26','32','64','65') or biz_id is null)) t1
 left join (select user_pin as pin
                  ,ordr_id as orderid
                  ,prin_camp_amt as discountamount
                  ,prefr_type as type
           from (select *
                       ,row_number() over (partition by ordr_id,coupon_code order by dt desc) as rn
                 from idm.idm_f05_bt_coupon_ordr_i_d) t
                 where rn=1
                 and prefr_type in ('csf_zj','csf_mj','csf_sjlj')) t2
on t1.ordr_id=t2.orderid
```

#### 1.6 白条首活表-拆首活场景
```SQL
ql_runner=RUNNER_HIVE


def get_customized_items():
    """
     if you need some special values in your sql, please define and calculate then here
     to refer it as {YOUR_VAR} in your sql
    """
    today = Time.today()
    TX_PRE_60_DATE = Time.date_sub(date=today, itv=60)
    TX_PRE_365_DATE = Time.date_sub(date=today, itv=365)
    return locals()


sql_map={

     # ATTENTION:   ！！！！ sql_01  因为系统按字典顺序进行排序，小于10 的一定要写成0加编号，否则会顺序混乱，数据出问题，切记，切记！！！！
    "sql_01":"""
    --订单排序并对交易订单匹配手续费成本
use dmc_tmp;

drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_user_new_incrs_actv_i_d_01;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_user_new_incrs_actv_i_d_01 as 
select t1.*
       ,nvl(t2.discountamount,0) as discountamount
       ,t3.source_id as channel_id
       ,t3.create_time as jihuo_create_time
       ,case when sub_mht_nm in ('北京京东世纪信息技术有限公司','京东商城平台商户') then '商城' else jd_jr_out end as pord_type
from (select *
             ,row_number() over(PARTITION by user_pin order by loan_time asc) as row_num
      from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d
      where dt = '{TX_DATE}'
      and (biz_id not in ('8','9','10','11','12','13','16','23','25','26','32','64','65') or biz_id is null)) t1
left join (select user_pin as pin
                  ,ordr_id as orderid
                  ,prin_camp_amt as discountamount
                  ,prefr_type as type
           from (select *
                       ,row_number() over (partition by ordr_id,coupon_code order by dt desc) as rn
                 from idm.idm_f05_bt_coupon_ordr_i_d) t
                 where rn=1
                 ) t2
on t1.ordr_id=t2.orderid
inner join (select substr(createtime,1,10) as create_time
                  ,pin as user_pin
                  ,case when source_type2 in ('白条快捷') then 'FastBt'
                        else source_id end as source_id
                  ,source_price
           from dmc_bc.DMCBC_BC_CF_XBT_ACCOUNT_S_D
           where dt in ('{TX_DATE}')) t3
on t1.user_pin = t3.user_pin
left join dmc_add.dmcadd_add_cf_xbt_sourcetype_bizcode_i_d t4
on t1.src_type=t4.sourcetype and t1.biz_id=t4.bizcode;
    """,

    "sql_02": """
--首活用户数据
use dmc_tmp;

drop table if exists dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_user_new_incrs_actv_i_d_02;
create table dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_user_new_incrs_actv_i_d_02 as 
select substr(loan_time,1,10) as loan_time
       ,channel_id  --激活渠道
       ,pord_type --首活场景
       ,count(distinct user_pin) as shouhuo_renshu  --首活人数
       ,count(distinct case when datediff(loan_time,jihuo_create_time) between 0 and 29 then user_pin end) as xinhu_shouhuo_renshu  --新户首活人数
       ,count(distinct case when datediff(loan_time,jihuo_create_time) between 0 and 29 then null else user_pin end) as laohu_shouhuo_renshu  --老户首活人数
       ,sum(loan_prin) as loan_prin  --首活交易金额
       ,sum(case when datediff(loan_time,jihuo_create_time) between 0 and 29 then loan_prin else 0 end) as xinhu_loan_prin  --新户首活交易金额
       ,sum(case when datediff(loan_time,jihuo_create_time) between 0 and 29 then 0 else loan_prin end) as laohu_loan_prin  --老户首活交易金额
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_user_new_incrs_actv_i_d_01 t1
where row_num = 1
and substr(loan_time,1,10) between date_add('{TX_DATE}',-14) and '{TX_DATE}'
group by substr(loan_time,1,10)
       ,channel_id 
       ,pord_type;
  
    """,

    "sql_03": """
use dmc_oa;

insert overwrite table dmc_oa.dmcoa_oa_xjbt_cf_xbt_user_new_incrs_actv_i_d partition (dt)
select loan_time
       ,channel_id
       ,pord_type
       ,shouhuo_renshu
       ,xinhu_shouhuo_renshu
       ,laohu_shouhuo_renshu
       ,loan_prin
       ,xinhu_loan_prin
       ,laohu_loan_prin
       ,loan_prin/shouhuo_renshu as shouhuo_renjun
       ,xinhu_loan_prin/xinhu_shouhuo_renshu as xinhu_shouhuo_renjun
       ,laohu_loan_prin/laohu_shouhuo_renshu as laohu_shouhuo_renjun
       ,loan_time as dt
from dmc_tmp.tmp_dmcoa_oa_xjbt_cf_xbt_user_new_incrs_actv_i_d_02;

    """,```








### 0.表格使用
#### 商城订单
以表二订单状态作为判断条件，只统计表一数据，确保数据准确性

```sql
select
  '{TX_DATE}'  as sale_ord_dt
  ,count(distinct user_log_acct) as sc_user_num  --白条用户当天商城活跃情况
  ,count(distinct case when t2.ordr_id is not null then user_log_acct end) as bt_user_num --白条用户当天商城使用白条活跃情况
  ,count(distinct parent_sale_ord_id) as sc_order_num  --白条用户当天商城订单情况
  ,count(distinct case when t2.ordr_id is not null then parent_sale_ord_id end) as bt_order_num  --白条用户当天商城使用白条订单情况
 ,sum(user_actual_pay_amount)                                                                 as amount_sc       --白条用户当天商城交易额                                                                         
 ,sum(case when t2.ordr_id is not null then user_actual_pay_amount else 0 end)                as bt_net_amount --白条用户当天在商城交易额使用白条支付的
from (select substr(sale_ord_dt,1,10) as sale_ord_dt
             ,user_log_acct
             ,parent_sale_ord_id
             ,user_actual_pay_amount  --用户实际支付金额
      from odm.odm_jdmall_sale_ordr_m04_sum_dtl_i_d 
      where dt>= '{TX_DATE}' 
      and sale_ord_dt ='{TX_DATE}' 
      and sale_ord_valid_flag=1) t1
left join (select ordr_id
            from sdm.sdm_f02_cf_xbt_ordr_dtl_s_d
            where dt = '{TX_DATE}' 
            and substr(loan_time,1,10) = '{TX_DATE}') t2
on t1.parent_sale_ord_id =t2.ordr_id
inner join (select dt
                   ,pin as user_pin
                   ,planrate
                   ,createtime
            from odm.ODM_CF_ACCOUNT_S_D
            where dt in ('{TX_DATE}' )
            and accounttype in ('0','1','5','6') )t3 
on t1.user_log_acct =t3.user_pin;```


#### 账单表 odmbilldetail

billplandate  autoplandate
```sql
use dmc_tmp;
DROP TABLE  if exists dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_03;
CREATE TABLE dmc_tmp.tmp_dmcbc_xfjr_cf_xbt_divid_data_split_i_d_03 AS
--amount 账单明细本金
--refundamt 退款金额
--planfeediscount 手续费优惠
--cxplanfeedst 退款冲销手续费优惠
--cxplanfeeamt 退款冲销待还手续费
select '{TX_DATE}'  as sale_ord_dt
       ,sum(amount-refundamt)  as loan_prin
       ,sum(planfee-planfeediscount-cxplanfeedst-cxplanfeeamt) as planfee  --应收账单分期手续费
from ODM.ODM_CF_BILL_DETAIL_0000_S_D --and plantype in ('2','3','4')
where dt= '{TX_DATE}'
and (bizcode  not in ('8','9','10','11','12','13','16','23','25','26','32','64','65')or bizcode is null)
and plantype in ('2','3','4')
and to_date(coalesce(billplandate,autoplandate)) = '{TX_DATE}';
```
